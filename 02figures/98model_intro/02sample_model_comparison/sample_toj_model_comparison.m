close all; clc; clear all;

pre_ms_unique = [-0.500000000000000	-0.300000000000000	-0.250000000000000	-0.200000000000000	-0.150000000000000	-0.100000000000000	-0.0500000000000000	0	0.0500000000000000	0.100000000000000	0.150000000000000	0.200000000000000	0.250000000000000	0.300000000000000	0.500000000000000]*1e3;

%make a finer grid for the timing difference between the auditory and the
%visual stimulus
SOA_finer = linspace(pre_ms_unique(1), pre_ms_unique(end), 1000);

% define PMF
P_Afirst = @(SOA, mu, sig, c, lambda) lambda/3 + (1-lambda).*normcdf(-c, SOA - mu, sig);
P_Vfirst = @(SOA, mu, sig, c, lambda) lambda/3 + (1-lambda).*(1 - normcdf(c, SOA-mu, sig));
P_simultaneous = @(SOA, mu, sig, c, lambda) ...
    1 - (lambda/3 + (1-lambda).*normcdf(-c, SOA - mu, sig)) ...
    - (lambda/3 + (1-lambda).*(1 - normcdf(c, SOA-mu, sig)));

M1 = {@(p) P_Afirst(SOA_finer, p(1), p(3), p(5), p(7));...
    @(p) P_Vfirst(SOA_finer, p(1), p(3), p(5), p(7));...
    @(p) P_simultaneous(SOA_finer, p(1), p(3), p(5), p(7));...
    @(p) P_Afirst(SOA_finer, p(2), p(4), p(6), p(8));...
    @(p) P_Vfirst(SOA_finer, p(2), p(4), p(6), p(8));...
    @(p) P_simultaneous(SOA_finer, p(2), p(4), p(6), p(8))};

M2 = {@(p) P_Afirst(SOA_finer, p(1), p(3), p(4), p(6));...
    @(p) P_Vfirst(SOA_finer, p(1), p(3), p(4), p(6));...
    @(p) P_simultaneous(SOA_finer, p(1), p(3), p(4), p(6));...
    @(p) P_Afirst(SOA_finer, p(2), p(3), p(5), p(7));...
    @(p) P_Vfirst(SOA_finer, p(2), p(3), p(5), p(7));...
    @(p) P_simultaneous(SOA_finer, p(2), p(3), p(5), p(7))};

M3 = {@(p) P_Afirst(SOA_finer, p(1), p(3), p(5), p(6));...
    @(p) P_Vfirst(SOA_finer, p(1), p(3), p(5), p(6));...
    @(p) P_simultaneous(SOA_finer, p(1), p(3), p(5), p(6));...
    @(p) P_Afirst(SOA_finer, p(2), p(4), p(5), p(7));...
    @(p) P_Vfirst(SOA_finer, p(2), p(4), p(5), p(7));...
    @(p) P_simultaneous(SOA_finer, p(2), p(4), p(5), p(7))};

M4 = {@(p) P_Afirst(SOA_finer, p(1), p(3), p(4), p(5));...
    @(p) P_Vfirst(SOA_finer, p(1), p(3), p(4), p(5));...
    @(p) P_simultaneous(SOA_finer, p(1), p(3), p(4), p(5));...
    @(p) P_Afirst(SOA_finer, p(2), p(3), p(4), p(6));...
    @(p) P_Vfirst(SOA_finer, p(2), p(3), p(4), p(6));...
    @(p) P_simultaneous(SOA_finer, p(2), p(3), p(4), p(6))};

M5 = {@(p) P_Afirst(SOA_finer, p(1), p(2), p(3), p(5));...
    @(p) P_Vfirst(SOA_finer, p(1), p(2), p(3), p(5));...
    @(p) P_simultaneous(SOA_finer, p(1), p(2), p(3), p(5));...
    @(p) P_Afirst(SOA_finer, p(1), p(2), p(4), p(6));...
    @(p) P_Vfirst(SOA_finer, p(1), p(2), p(4), p(6));...
    @(p) P_simultaneous(SOA_finer, p(1), p(2), p(4), p(6))};

M6 = {@(p) P_Afirst(SOA_finer, p(1), p(2), p(3), p(4));...
    @(p) P_Vfirst(SOA_finer, p(1), p(2), p(3), p(4));...
    @(p) P_simultaneous(SOA_finer, p(1), p(2), p(3), p(4));...
    @(p) P_Afirst(SOA_finer, p(1), p(2), p(3), p(5));...
    @(p) P_Vfirst(SOA_finer, p(1), p(2), p(3), p(5));...
    @(p) P_simultaneous(SOA_finer, p(1), p(2), p(3), p(5))};

models = {M1; M2; M3; M4; M5; M6};

%% plug in best-fitting parameters and plot

% plot raw data
cMAP1 = [158,202,225; 161,217,155; 252,174,145]./255;
cMAP2 = [33,113,181; 35,139,69; 203,24,29]./255;

bestPs = {[42.84, -20.277, 66.131, 49.306, 109.76, 82.858, 0.01, 0.06];
    [42.84, -20.277, 66.131, 109.76, 82.858, 0.01, 0.06];
    [42.84, -20.277, 66.131, 49.306, 109.76, 0.01, 0.06];
    [42.84, -20.277, 66.131, 109.76, 0.01, 0.06];
    [42.84, 66.131, 109.76, 82.858, 0.01, 0.06];
    [42.84, 66.131, 109.76, 0.01, 0.06]};

% plot fitting curves

for m = 1:6
    bestP = bestPs{m};
    Pre_Afirst_fit = models{m}{1}(bestP);
    Pre_Vfirst_fit = models{m}{2}(bestP);
    Pre_simul_fit = models{m}{3}(bestP);
    Post_Afirst_fit = models{m}{4}(bestP);
    Post_Vfirst_fit = models{m}{5}(bestP);
    Post_simul_fit = models{m}{6}(bestP);

    figure; hold on
    set(gca, 'LineWidth', 2, 'FontSize', 15)
    set(gcf, 'Position',[10 10 500 400])

    plot(SOA_finer, Pre_Afirst_fit, '--','Color', cMAP1(3,:), 'lineWidth', 3)
    plot(SOA_finer, Pre_Vfirst_fit, '--','Color', cMAP1(1,:), 'lineWidth', 3)
    plot(SOA_finer, Pre_simul_fit, '--','Color', cMAP1(2,:), 'lineWidth', 3)

    plot(SOA_finer, Post_Afirst_fit, '-','Color', cMAP2(3,:), 'lineWidth', 3)
    plot(SOA_finer, Post_Vfirst_fit, '-','Color', cMAP2(1,:), 'lineWidth', 3)
    plot(SOA_finer, Post_simul_fit, '-','Color', cMAP2(2,:), 'lineWidth', 3)

%     % display best fitting parameters
%     annotation( 'textbox', 'String', round(bestP,3), ...
%         'FontSize', 14, 'Units', 'normalized', 'EdgeColor', 'none', ...
%         'Position', [0.9,0.9,0.03,0.03], 'Interpreter','Latex')

    % look better
    xlabel('SOA (ms)')
    ylabel('probability')
    tt = ['M' num2str(m)];
    title(tt)

    saveas(gca,tt,'epsc')

end